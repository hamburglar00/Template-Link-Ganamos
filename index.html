<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ganamos</title>
  <link rel="icon" href="imagenes/logo.png" />
  <link rel="preload" as="image" href="imagenes/background.png">
  <link rel="preload" as="image" href="imagenes/perro.png">
  <link rel="stylesheet" href="styles.css" />

  <!-- Prefetch API -->
  <link rel="preconnect" href="https://api.asesadmin.com" crossorigin>
  <link rel="dns-prefetch" href="https://api.asesadmin.com">

  <style>
    html { visibility: hidden; }

    /* ‚úÖ Toast / cartel */
    .gn-toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(21, 0, 40, 0.92);
      color: #fff;
      border: 1px solid rgba(255, 188, 15, 0.35);
      box-shadow: 0 12px 30px rgba(0,0,0,0.55);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: min(92vw, 460px);
      text-align: center;
    }
    .gn-toast.is-open {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
    .gn-toast strong { color: #ffbc0f; }
  </style>

  <script>
    /********************************************
     * REDIRECCI√ìN ALEATORIA (sin parpadeo)
     ********************************************/
    const REDIRECT_PROBABILITY = 0;
    const REDIRECT_URL = "https://ganamosnet.one";

    if (Math.random() < REDIRECT_PROBABILITY) {
      window.location.replace(REDIRECT_URL);
    } else {
      document.addEventListener("DOMContentLoaded", () => {
        document.documentElement.style.visibility = "visible";
      });
    }
  </script>
</head>

<body>
  <main class="gn-stage">
    <div class="gn-wrap" id="cardContainer"></div>
  </main>

  <!-- ‚úÖ Cartel / Toast -->
  <div id="gnToast" class="gn-toast" role="status" aria-live="polite"></div>

  <!-- ‚úÖ Popup (solo HTML + clases; el CSS lo movemos luego a styles.css) -->
  <div id="gnPhoneModal" class="gn-modal" aria-hidden="true">
    <div class="gn-modal-backdrop" data-close-modal></div>

    <div class="gn-modal-card" role="dialog" aria-modal="true" aria-labelledby="gnModalTitle">
      <div class="gn-modal-head">
        <div>
          <div id="gnModalTitle" class="gn-modal-title">N√∫mero oficial</div>
          <div class="gn-modal-sub">Toc√° el √≠cono para copiar</div>
        </div>

        <button class="gn-modal-x" data-close-modal aria-label="Cerrar">‚úï</button>
      </div>

      <div class="gn-modal-body">
        <div class="gn-phone-row">
          <span id="gnPhoneText" class="gn-phone-text">‚Äî</span>

          <button id="gnCopyBtn" class="gn-copy-btn" type="button" aria-label="Copiar n√∫mero">
            üìã
          </button>
        </div>

        <div class="gn-modal-actions">
          <button class="gn-btn gn-btn-outline" type="button" data-close-modal>
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /********************************************
     * CONFIGURACI√ìN (EDITAR SOLO ESTO)
     ********************************************/
    const TELEGRAM_ENABLED = false; // ‚úÖ flag: si es false, muestra cartel y NO abre Telegram
    const TELEGRAM_URL = "https://t.me/"; // tu URL real si lo activ√°s
    const TELEGRAM_DISABLED_MESSAGE = "üö´ Telegram est√° desactivado por el momento. Prob√° por WhatsApp.";

    /********************************************
     * TOAST / CARTEL
     ********************************************/
    let __toastTimer = null;
    function showToast(msg, ms = 2200) {
      const el = document.getElementById("gnToast");
      if (!el) return;

      el.innerHTML = msg;
      el.classList.add("is-open");

      clearTimeout(__toastTimer);
      __toastTimer = setTimeout(() => {
        el.classList.remove("is-open");
      }, ms);
    }

    /********************************************
     * ‚úÖ Util: quitar "549" SOLO para mostrar
     ********************************************/
    function strip549ForDisplay(phoneRaw) {
      const digits = String(phoneRaw || "").replace(/\D/g, "");
      if (digits.startsWith("549")) return digits.slice(3);
      return digits;
    }

    /********************************************
     * ‚úÖ Modal helpers
     ********************************************/
    function openPhoneModal(displayNumber) {
      const modal = document.getElementById("gnPhoneModal");
      const phoneText = document.getElementById("gnPhoneText");
      const copyBtn = document.getElementById("gnCopyBtn");

      if (!modal || !phoneText || !copyBtn) return;

      phoneText.textContent = displayNumber || "‚Äî";

      copyBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(displayNumber || "");
          showToast(`<strong>Copiado</strong><br>Copiado ‚úîÔ∏è`);
        } catch (e) {
          showToast(`<strong>Error</strong><br>No se pudo copiar.`);
        }
      };

      modal.classList.add("is-open");
      modal.setAttribute("aria-hidden", "false");
    }

    function closePhoneModal() {
      const modal = document.getElementById("gnPhoneModal");
      if (!modal) return;
      modal.classList.remove("is-open");
      modal.setAttribute("aria-hidden", "true");
    }

    // Cerrar modal por backdrop / botones
    document.addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.hasAttribute && t.hasAttribute("data-close-modal")) {
        e.preventDefault();
        closePhoneModal();
      }
    });

    // Cerrar con ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closePhoneModal();
    });

    /********************************************
     * DISE√ëOS
     ********************************************/
    const DESIGNS = {
      whatsapp: {
        probability: 1,
        render: () => `
          <img src="imagenes/mascot.webp" style="padding:0 20px;position:absolute;z-index:1;bottom:45vh;left:50%;max-width:200px;transform:translate(-50%,0);" decoding="async" />
          <div style="position:relative;background:#150028;box-shadow:0 0 0 2px rgba(154,76,255,0.15) inset,0 14px 40px rgba(0,0,0,0.65),0 0 26px rgba(154,76,255,0.35);padding:24px;border-radius:30px;max-width:350px;margin:0 auto;z-index:2;">
            <img src="imagenes/logo-net-new.png" alt="" style="width:100%;padding:0 50px;max-width:300px;margin:0 auto;display:block;">
            <h4 style="text-align:center;padding-top:10px;">¬øEl cajero no responde por WhatsApp?</h4>
            <p style="text-align:center;padding-top:20px;font-size:12px;">Si el n√∫mero con el que hablabas deja de funcionar, pod√©s volver a contactarnos desde nuestro canal oficial.</p>
            <p style="text-align:center;padding-top:10px;font-size:12px;font-style:italic;color:#ffbc0f;">¬°Conserv√°s tu usuario y tus fichas!</p>

            <div class="gn-actions" style="max-width:230px;margin:20px auto;display:flex;flex-direction:column;gap:12px;">
              <a href="#" id="btnContactar" class="gn-btn gn-btn-solid">
                <img src="imagenes/whatsapp.png" alt="" class="wa-ic"> CONTACTANOS
              </a>

              <a href="https://ganamosnet.biz" target="_blank" rel="noopener" class="gn-btn gn-btn-outline">
                <img src="imagenes/rocket_1f680.png" alt="" class="wa-ic"> JUGAR AHORA
              </a>

              <!-- ‚úÖ Telegram con ID para poder bloquearlo si est√° desactivado -->
              <a href="${TELEGRAM_URL || '#'}" target="_blank" rel="noopener" id="btnTelegram"
                 class="gn-btn gn-btn-telegram" style="position:relative;">
                <img src="imagenes/telegram.png" alt="" class="wa-ic"> TELEGRAM
                <span style="
                  position:absolute;
                  top:4px;
                  right:-4px;
                  background:#ffbc0f;
                  color:#150028;
                  font-size:9px;
                  font-weight:700;
                  border-radius:6px;
                  padding:2px 6px;
                  box-shadow:0 0 6px rgba(0,0,0,0.4);
                  text-transform:uppercase;
                  letter-spacing:0.3px;
                ">BONO</span>
              </a>
            </div>

            <p style="text-align:center;font-size:8.4px;color:#ffbc0f;margin-top:-5px;">
              ¬°Jugando por Telegram ten√©s BONO EN TODAS TUS CARGAS!
            </p>
          </div>
        `
      },

      telegram: {
        probability: 0,
        render: () => `
          <img src="imagenes/mascot.webp" style="padding:0 20px;position:absolute;z-index:1;bottom:22vh;left:50%;max-width:300px;transform:translate(-50%,0);" decoding="async" />
          <div style="position:relative;background:#150028;box-shadow:0 0 0 2px rgba(76,186,255,0.15) inset,0 14px 40px rgba(0,0,0,0.65),0 0 26px rgba(76,186,255,0.35);padding:24px;border-radius:30px;max-width:350px;margin:0 auto;z-index:2;">
            <img src="imagenes/logo-net-new.png" alt="" style="width:100%;padding:0 50px;max-width:300px;margin:0 auto;display:block;">
            <h4 style="text-align:center;padding-top:10px;">TODAS TUS CARGAS CON BONO</h4>
            <p style="text-align:center;padding-top:20px;font-size:12px;">üö®Nuevo beneficio exclusivo: jugando por Telegram obten√©s bono en todas tus cargas y ahora con pagos autom√°ticos al instante.</p>
            <p style="text-align:center;padding-top:10px;font-size:12px;font-style:italic;color:#ffbc0f;">
              ¬øA√∫n no ten√©s Telegram? Descargala y empez√° a ganar.
            </p>

            <div class="gn-actions" style="max-width:200px;margin:20px auto;">
              <a href="${TELEGRAM_URL || '#'}" target="_blank" id="btnTelegram"
                 class="gn-btn gn-btn-telegram">
                <img src="imagenes/telegram.png" alt="" class="wa-ic"> TELEGRAM
              </a>
              <a href="https://ganamosnet.biz" target="_blank" rel="noopener" class="gn-btn gn-btn-outline">
                <img src="imagenes/rocket_1f680.png" alt="" class="wa-ic"> JUGAR AHORA
              </a>
            </div>
          </div>
        `
      }
    };

    /********************************************
     * ELECCI√ìN ALEATORIA DE DISE√ëO
     ********************************************/
    const rand = Math.random();
    const design = rand < DESIGNS.whatsapp.probability ? "whatsapp" : "telegram";
    document.getElementById("cardContainer").innerHTML = DESIGNS[design].render();

    /********************************************
     * ‚úÖ BLOQUEO DE TELEGRAM SI FLAG = false
     ********************************************/
    function wireTelegramButton() {
      const btnTelegram = document.getElementById("btnTelegram");
      if (!btnTelegram) return;

      btnTelegram.addEventListener("click", (e) => {
        // Si est√° deshabilitado, NO dejamos navegar
        if (!TELEGRAM_ENABLED) {
          e.preventDefault();
          e.stopPropagation();
          showToast(`<strong>Canal desactivado</strong><br>${TELEGRAM_DISABLED_MESSAGE}`);
          return;
        }

        // Si est√° habilitado pero no hay URL, tambi√©n avisamos
        if (!TELEGRAM_URL) {
          e.preventDefault();
          e.stopPropagation();
          showToast(`<strong>No disponible</strong><br>Telegram no est√° configurado a√∫n.`);
          return;
        }
      });
    }
    wireTelegramButton();

    /********************************************
     * ‚úÖ L√ìGICA WHATSAPP: ahora abre POPUP + copiar
     ********************************************/
    if (design === "whatsapp") {
      const SERVICE_URL = "/api/get-random-phone";
      const FALLBACK = [{ phone: "+549351", weight: 1 }];
      const TTL_MS = 5 * 60 * 1000;
      const LS_KEY = `active_whatsapp_numbers_by_agency:1`;

      function fetchWithTimeout(url, opt = {}, ms = 2500) {
        const ctrl = new AbortController();
        const id = setTimeout(() => ctrl.abort(), ms);
        return fetch(url, { ...opt, signal: ctrl.signal }).finally(() => clearTimeout(id));
      }
      function getCache() { try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; } }
      function setCache(numbers) { localStorage.setItem(LS_KEY, JSON.stringify({ ts: Date.now(), numbers })); }

      function parseApiPayload(data) {
        if (data && typeof data === "object" && (typeof data.phone_number === "string" || typeof data.phone_number === "number")) {
          return [{ phone: String(data.phone_number), weight: 1 }];
        }
        if (typeof data === "string") return [{ phone: data, weight: 1 }];
        const arr = (Array.isArray(data?.numbers) && data.numbers)
          || (Array.isArray(data?.phone_numbers) && data.phone_numbers)
          || (Array.isArray(data) && data)
          || [];
        return arr.map(item => {
          if (typeof item === "string") return { phone: item, weight: 1 };
          const phone = String(item?.phone ?? item?.phone_number ?? "").trim();
          const w = Number(item?.weight ?? 1);
          return { phone, weight: isFinite(w) && w > 0 ? w : 1 };
        });
      }

      function normalizeNumbers(list) {
        return (Array.isArray(list) ? list : [])
          .map(n => ({ phone: String(n.phone || "").trim(), weight: Number(n.weight || 1) }))
          .filter(n => /^\+?\d{8,17}$/.test(n.phone) && n.weight > 0);
      }

      async function loadNumbersOnce() {
        const cached = getCache();
        try {
          const res = await fetchWithTimeout(SERVICE_URL, { headers: { "Cache-Control": "no-store" } }, 2500);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          const parsed = parseApiPayload(data);
          const clean = normalizeNumbers(parsed);
          if (clean.length) { setCache(clean); return clean; }
          throw new Error("Invalid payload");
        } catch (e) {
          const ok = cached?.numbers?.length && Date.now() - (cached.ts || 0) < TTL_MS;
          return ok ? cached.numbers : normalizeNumbers(FALLBACK);
        }
      }

      function pickWeightedRandom(list) {
        const total = list.reduce((s, it) => s + (Number(it.weight) || 1), 0);
        let r = Math.random() * total;
        for (const it of list) { r -= (Number(it.weight) || 1); if (r <= 0) return it; }
        return list[list.length - 1];
      }

      let activeList = [];
      loadNumbersOnce().then(list => { activeList = list; });

      document.getElementById("btnContactar").addEventListener("click", (e) => {
        e.preventDefault();

        if (!activeList.length) {
          showToast(`<strong>Un momento</strong><br>Estamos cargando el contacto...`);
          return;
        }

        const chosen = pickWeightedRandom(activeList);
        const displayNumber = strip549ForDisplay(chosen.phone);

        openPhoneModal(displayNumber);
      });
    }
  </script>
</body>
</html>
