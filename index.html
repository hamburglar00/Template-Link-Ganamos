<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ganamos</title>
  <link rel="icon" href="imagenes/logo.png" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    html { visibility: hidden; }

    .gn-toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(21,0,40,.92);
      color: #fff;
      border: 1px solid rgba(255,188,15,.35);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: .2s;
      text-align: center;
    }
    .gn-toast.is-open {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
    .gn-toast strong { color:#ffbc0f }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.documentElement.style.visibility = "visible";
    });
  </script>
</head>

<body>
  <main class="gn-stage">
    <div class="gn-wrap" id="cardContainer"></div>
  </main>

  <div id="gnToast" class="gn-toast"></div>

  <script>
    /*************** CONFIG ***************/
    const SERVICE_URL = "/api/get-random-phone";

    // üëá puede estar vac√≠o, inv√°lido o tener n√∫mero
    const FALLBACK = [{ phone: "", weight: 1 }];

    const TELEGRAM_ENABLED = false;
    const TELEGRAM_URL = "https://t.me/";
    const TELEGRAM_DISABLED_MESSAGE =
      "üö´ Telegram est√° desactivado por el momento. Prob√° por WhatsApp.";

    /*************** TOAST ***************/
    let toastTimer = null;
    function showToast(msg, ms = 2200) {
      const el = document.getElementById("gnToast");
      el.innerHTML = msg;
      el.classList.add("is-open");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => el.classList.remove("is-open"), ms);
    }

    /*************** UI ***************/
    document.getElementById("cardContainer").innerHTML = `
      <div style="max-width:350px;margin:0 auto;background:#150028;padding:24px;border-radius:24px;">
        <h4 style="text-align:center;color:#fff">
          ¬øEl cajero no responde por WhatsApp?
        </h4>

        <div style="margin-top:20px;display:flex;flex-direction:column;gap:12px;">
          <a href="#" id="btnContactar" class="gn-btn gn-btn-solid">
            CONTACTANOS
          </a>

          <a href="${TELEGRAM_URL || '#'}" id="btnTelegram"
             class="gn-btn gn-btn-telegram" target="_blank">
            TELEGRAM
          </a>
        </div>
      </div>
    `;

    /*************** TELEGRAM ***************/
    document.getElementById("btnTelegram").addEventListener("click", e => {
      if (!TELEGRAM_ENABLED) {
        e.preventDefault();
        showToast(
          `<strong>Canal desactivado</strong><br>${TELEGRAM_DISABLED_MESSAGE}`
        );
      }
    });

    /*************** WHATSAPP ***************/
    function normalizeNumbers(list) {
      return (Array.isArray(list) ? list : [])
        .map(n => ({ phone: String(n.phone || "").trim(), weight: 1 }))
        .filter(n => /^\+?\d{8,17}$/.test(n.phone));
    }

    async function loadNumbersOnce() {
      try {
        const res = await fetch(SERVICE_URL, { cache: "no-store" });
        if (!res.ok) throw 0;
        const data = await res.json();
        const list = normalizeNumbers(
          Array.isArray(data) ? data : [data]
        );
        if (list.length) return list;
      } catch {}
      return normalizeNumbers(FALLBACK);
    }

    function pickRandom(list) {
      return list[Math.floor(Math.random() * list.length)];
    }

    function buildWaUrl(phone, text) {
      return `https://api.whatsapp.com/send?phone=${
        phone.replace(/\D/g,"")
      }&text=${encodeURIComponent(text)}`;
    }

    let activeList = [];

    async function getWhatsappTarget() {
      if (activeList.length) return pickRandom(activeList);
      activeList = await loadNumbersOnce();
      return activeList.length ? pickRandom(activeList) : null;
    }

    document.getElementById("btnContactar").addEventListener("click", async e => {
      e.preventDefault();

      showToast("‚è≥ Conectando con WhatsApp...");

      const target = await getWhatsappTarget();
      if (!target) {
        showToast("‚ùå WhatsApp no disponible en este momento");
        return;
      }

      window.open(
        buildWaUrl(target.phone, "¬°Hola! Me pas√°s mi usuario üöÄ"),
        "_self"
      );
    });
  </script>
</body>
</html>
